<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MaxBot Plugins</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #1e1e1e;
      color: #e0e0e0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background-color: #2d2d2d;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .status {
      display: flex;
      align-items: center;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .connected { background-color: #4CAF50; }
    .disconnected { background-color: #F44336; }
    .error { background-color: #FF9800; }
    
    .nav {
      display: flex;
      margin-bottom: 20px;
    }
    .nav-item {
      padding: 10px 20px;
      background-color: #2d2d2d;
      border-radius: 5px;
      margin-right: 10px;
      cursor: pointer;
      text-decoration: none;
      color: #e0e0e0;
    }
    .nav-item:hover {
      background-color: #3a3a3a;
    }
    
    .plugin-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .plugin-card {
      background-color: #2d2d2d;
      border-radius: 5px;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    
    .plugin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .plugin-title {
      font-size: 18px;
      font-weight: bold;
      margin: 0;
    }
    
    .plugin-version {
      font-size: 12px;
      color: #aaa;
    }
    
    .plugin-description {
      margin-bottom: 15px;
      color: #ccc;
    }
    
    .plugin-status {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .plugin-status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .plugin-enabled { background-color: #4CAF50; }
    .plugin-disabled { background-color: #F44336; }
    
    .plugin-actions {
      display: flex;
      justify-content: space-between;
      margin-top: auto;
    }
    
    .plugin-button {
      padding: 8px 15px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      background-color: #3a3a3a;
      color: white;
    }
    
    .plugin-button:hover {
      background-color: #4a4a4a;
    }
    
    .plugin-button.enable {
      background-color: #4CAF50;
    }
    
    .plugin-button.enable:hover {
      background-color: #45a049;
    }
    
    .plugin-button.disable {
      background-color: #F44336;
    }
    
    .plugin-button.disable:hover {
      background-color: #d32f2f;
    }
    
    .plugin-button.configure {
      background-color: #2196F3;
    }
    
    .plugin-button.configure:hover {
      background-color: #0b7dda;
    }
    
    .plugin-config {
      background-color: #1a1a1a;
      border-radius: 5px;
      padding: 15px;
      margin-top: 15px;
      display: none;
    }
    
    .plugin-config.active {
      display: block;
    }
    
    .config-item {
      margin-bottom: 15px;
    }
    
    .config-label {
      display: block;
      margin-bottom: 5px;
      color: #aaa;
    }
    
    .config-input {
      width: 100%;
      padding: 8px;
      background-color: #3a3a3a;
      border: 1px solid #444;
      border-radius: 3px;
      color: #e0e0e0;
      box-sizing: border-box;
    }
    
    .config-select {
      width: 100%;
      padding: 8px;
      background-color: #3a3a3a;
      border: 1px solid #444;
      border-radius: 3px;
      color: #e0e0e0;
    }
    
    .config-checkbox {
      margin-right: 5px;
    }
    
    .config-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }
    
    .translator-languages {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    
    .language-chip {
      background-color: #3a3a3a;
      border-radius: 15px;
      padding: 5px 10px;
      display: flex;
      align-items: center;
    }
    
    .language-chip-remove {
      margin-left: 5px;
      cursor: pointer;
      color: #aaa;
    }
    
    .language-chip-remove:hover {
      color: #F44336;
    }
    
    .add-language {
      display: flex;
      margin-top: 10px;
      gap: 10px;
    }
    
    .add-language select {
      flex: 1;
    }
    
    .color-picker-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    
    .color-picker-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    
    .color-picker-item label {
      font-size: 12px;
      color: #aaa;
    }
    
    .color-picker-item input[type="color"] {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 5px;
      background: none;
      cursor: pointer;
    }
    
    @media (max-width: 768px) {
      .plugin-list {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>MaxBot Plugins</h1>
      <div class="status">
        <div id="status-indicator" class="status-indicator disconnected"></div>
        <span id="status-text">Disconnected</span>
      </div>
    </div>
    
    <div class="nav">
      <a href="/" class="nav-item">Dashboard</a>
      <a href="/plugins.html" class="nav-item">Plugins</a>
    </div>
    
    <div class="info-message" style="background-color: #2d2d2d; padding: 10px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #4CAF50;">
      <p style="margin: 0;">ðŸ’¬ <strong>Note:</strong> Chat functionality is available on the <a href="/" style="color: #4CAF50; text-decoration: underline;">Dashboard</a> page.</p>
    </div>
    
    <div id="plugin-list" class="plugin-list">
      <!-- Plugin cards will be added here -->
      <div class="plugin-card">
        <div class="plugin-header">
          <h3 class="plugin-title">Loading plugins...</h3>
        </div>
      </div>
    </div>
    
    <!-- Translator Plugin Configuration Template -->
    <template id="translator-config-template">
      <div class="plugin-config" id="translator-config">
        <div class="config-item">
          <label class="config-label">API Key</label>
          <input type="text" class="config-input" id="translator-api-key" placeholder="Enter translation API key">
        </div>
        
        <div class="config-item">
          <label class="config-label">Default Target Language</label>
          <select class="config-select" id="translator-default-language">
            <!-- Options will be added dynamically -->
          </select>
        </div>
        
        <div class="config-item">
          <label class="config-checkbox-label">
            <input type="checkbox" class="config-checkbox" id="translator-incoming">
            Translate incoming messages
          </label>
        </div>
        
        <div class="config-item">
          <label class="config-checkbox-label">
            <input type="checkbox" class="config-checkbox" id="translator-outgoing">
            Translate outgoing messages
          </label>
        </div>
        
        <div class="config-item">
          <label class="config-label">Outgoing Translation Languages</label>
          <div class="translator-languages" id="translator-outgoing-languages">
            <!-- Language chips will be added here -->
          </div>
          
          <div class="add-language">
            <select class="config-select" id="translator-add-language">
              <!-- Options will be added dynamically -->
            </select>
            <button class="plugin-button" id="translator-add-language-btn">Add</button>
          </div>
        </div>
        
        <div class="config-actions">
          <button class="plugin-button" id="translator-cancel">Cancel</button>
          <button class="plugin-button configure" id="translator-save">Save</button>
        </div>
      </div>
    </template>
    
    <!-- Chat Plugin Configuration Template -->
    <template id="chat-config-template">
      <div class="plugin-config" id="chat-config">
        <div class="config-item">
          <label class="config-label">Max Messages</label>
          <input type="number" class="config-input" id="chat-max-messages" placeholder="Maximum number of messages to store">
        </div>
        
        <div class="config-item">
          <label class="config-checkbox-label">
            <input type="checkbox" class="config-checkbox" id="chat-show-timestamps">
            Show timestamps in chat
          </label>
        </div>
        
        <div class="config-item">
          <label class="config-checkbox-label">
            <input type="checkbox" class="config-checkbox" id="chat-show-badges">
            Show user badges in chat
          </label>
        </div>
        
        <div class="config-item">
          <label class="config-checkbox-label">
            <input type="checkbox" class="config-checkbox" id="chat-highlight-mentions">
            Highlight messages that mention the bot
          </label>
        </div>
        
        <div class="config-item">
          <label class="config-label">Font Size</label>
          <select class="config-select" id="chat-font-size">
            <option value="small">Small</option>
            <option value="medium">Medium</option>
            <option value="large">Large</option>
          </select>
        </div>
        
        <div class="config-item">
          <label class="config-checkbox-label">
            <input type="checkbox" class="config-checkbox" id="chat-filter-commands">
            Filter out command messages from chat display
          </label>
        </div>
        
        <div class="config-item">
          <label class="config-checkbox-label">
            <input type="checkbox" class="config-checkbox" id="chat-show-notifications">
            Show chat notifications
          </label>
        </div>
        
        <div class="config-item">
          <label class="config-label">Chat Colors</label>
          <div class="color-picker-group">
            <div class="color-picker-item">
              <label>Background</label>
              <input type="color" id="chat-color-background">
            </div>
            <div class="color-picker-item">
              <label>Text</label>
              <input type="color" id="chat-color-text">
            </div>
            <div class="color-picker-item">
              <label>Timestamp</label>
              <input type="color" id="chat-color-timestamp">
            </div>
            <div class="color-picker-item">
              <label>Username</label>
              <input type="color" id="chat-color-username">
            </div>
            <div class="color-picker-item">
              <label>Mention</label>
              <input type="color" id="chat-color-mention">
            </div>
            <div class="color-picker-item">
              <label>Command</label>
              <input type="color" id="chat-color-command">
            </div>
          </div>
        </div>
        
        <div class="config-actions">
          <button class="plugin-button" id="chat-cancel">Cancel</button>
          <button class="plugin-button configure" id="chat-save">Save</button>
        </div>
      </div>
    </template>
  </div>
  
  <script>
    // Elements
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const pluginList = document.getElementById('plugin-list');
    
    // Plugin data
    let plugins = [];
    
    // Update status
    function updateStatus() {
      fetch('/api/status')
        .then(response => response.json())
        .then(data => {
          // Update status text to show both WebSocket and Twitch status
          statusText.textContent = 'WS: ' + data.wsStatus + ', Twitch: ' + data.twitchStatus;
          statusIndicator.className = 'status-indicator';
          
          // If both are connected, show connected status
          if (data.wsStatus === 'Connected' && data.twitchStatus === 'Connected') {
            statusIndicator.classList.add('connected');
          } else if (data.wsStatus === 'Error' || data.twitchStatus === 'Error') {
            statusIndicator.classList.add('error');
          } else {
            statusIndicator.classList.add('disconnected');
          }
        })
        .catch(error => {
          console.error('Error fetching status:', error);
          statusText.textContent = 'Error';
          statusIndicator.className = 'status-indicator error';
        });
    }
    
    // Fetch plugins
    function fetchPlugins() {
      fetch('/api/plugins')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // We need to wait for the WebSocket to send the plugin data
            // So we'll poll for updates
            setTimeout(fetchPluginStatus, 1000);
          }
        })
        .catch(error => {
          console.error('Error fetching plugins:', error);
          renderPlugins([]);
        });
    }
    
    // Fetch plugin status directly from the WebSocket
    function fetchPluginStatus() {
      // Make a request to get the actual plugin data
      fetch('/api/plugins')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // If we don't have plugin data yet, create default plugins
            // with supported languages until we get the real data
            const defaultTranslatorPlugin = {
              name: 'translator',
              description: 'Real-time chat message translator',
              version: '1.0.0',
              enabled: true,
              config: {
                defaultTargetLanguage: 'en',
                translateIncoming: false,
                translateOutgoing: true,
                supportedLanguages: {
                  'en': 'English',
                  'es': 'Spanish',
                  'fr': 'French',
                  'de': 'German',
                  'it': 'Italian',
                  'pt': 'Portuguese',
                  'ru': 'Russian',
                  'ja': 'Japanese',
                  'ko': 'Korean',
                  'zh': 'Chinese'
                },
                outgoingLanguages: ['es', 'fr']
              }
            };
            
            const defaultChatPlugin = {
              name: 'chat',
              description: 'Chat configuration and management',
              version: '1.0.0',
              enabled: true,
              config: {
                maxMessages: 100,
                showTimestamps: true,
                showBadges: true,
                highlightMentions: true,
                fontSizeChat: 'medium',
                chatColors: {
                  background: '#1e1e1e',
                  text: '#e0e0e0',
                  timestamp: '#888888',
                  username: '#4CAF50',
                  mention: '#ff9800',
                  command: '#2196F3'
                },
                filterCommands: false,
                showNotifications: true
              }
            };
            
            // Use the default plugins for now, but poll for updates
            plugins = [defaultTranslatorPlugin, defaultChatPlugin];
            renderPlugins(plugins);
            
            // Poll for updates from the WebSocket
            setTimeout(checkForPluginUpdates, 1000);
          } else {
            console.error('Error fetching plugins:', data.error);
          }
        })
        .catch(error => {
          console.error('Error fetching plugins:', error);
          
          // If there's an error, still show default plugins
          const defaultTranslatorPlugin = {
            name: 'translator',
            description: 'Real-time chat message translator',
            version: '1.0.0',
            enabled: true,
            config: {
              defaultTargetLanguage: 'en',
              translateIncoming: false,
              translateOutgoing: true,
              supportedLanguages: {
                'en': 'English',
                'es': 'Spanish',
                'fr': 'French',
                'de': 'German',
                'it': 'Italian',
                'pt': 'Portuguese',
                'ru': 'Russian',
                'ja': 'Japanese',
                'ko': 'Korean',
                'zh': 'Chinese'
              },
              outgoingLanguages: ['es', 'fr']
            }
          };
          
          const defaultChatPlugin = {
            name: 'chat',
            description: 'Chat configuration and management',
            version: '1.0.0',
            enabled: true,
            config: {
              maxMessages: 100,
              showTimestamps: true,
              showBadges: true,
              highlightMentions: true,
              fontSizeChat: 'medium',
              chatColors: {
                background: '#1e1e1e',
                text: '#e0e0e0',
                timestamp: '#888888',
                username: '#4CAF50',
                mention: '#ff9800',
                command: '#2196F3'
              },
              filterCommands: false,
              showNotifications: true
            }
          };
          
          plugins = [defaultTranslatorPlugin, defaultChatPlugin];
          renderPlugins(plugins);
        });
    }
    
    // Check for plugin updates from the WebSocket
    function checkForPluginUpdates() {
      // In a real implementation, this would check for WebSocket messages
      // For now, we'll just use our default plugin data
      console.log('Checking for plugin updates...');
    }
    
    // Render plugins
    function renderPlugins(plugins) {
      pluginList.innerHTML = '';
      
      if (plugins.length === 0) {
        const noPluginsCard = document.createElement('div');
        noPluginsCard.className = 'plugin-card';
        noPluginsCard.innerHTML = `
          <div class="plugin-header">
            <h3 class="plugin-title">No plugins found</h3>
          </div>
          <p class="plugin-description">No plugins are currently loaded.</p>
        `;
        pluginList.appendChild(noPluginsCard);
        return;
      }
      
      plugins.forEach(plugin => {
        const pluginCard = document.createElement('div');
        pluginCard.className = 'plugin-card';
        pluginCard.innerHTML = `
          <div class="plugin-header">
            <h3 class="plugin-title">${plugin.name}</h3>
            <span class="plugin-version">v${plugin.version}</span>
          </div>
          <p class="plugin-description">${plugin.description}</p>
          <div class="plugin-status">
            <div class="plugin-status-indicator ${plugin.enabled ? 'plugin-enabled' : 'plugin-disabled'}"></div>
            <span>${plugin.enabled ? 'Enabled' : 'Disabled'}</span>
          </div>
          <div class="plugin-actions">
            <button class="plugin-button ${plugin.enabled ? 'disable' : 'enable'}" data-plugin="${plugin.name}" data-action="${plugin.enabled ? 'disable' : 'enable'}">
              ${plugin.enabled ? 'Disable' : 'Enable'}
            </button>
            <button class="plugin-button configure" data-plugin="${plugin.name}" data-action="configure">Configure</button>
          </div>
        `;
        
        // Add event listeners
        pluginCard.querySelector(`button[data-action="${plugin.enabled ? 'disable' : 'enable'}"]`).addEventListener('click', handlePluginAction);
        pluginCard.querySelector('button[data-action="configure"]').addEventListener('click', handlePluginAction);
        
        pluginList.appendChild(pluginCard);
        
        // If this is the translator plugin, add its configuration
        if (plugin.name === 'translator') {
          const translatorConfigTemplate = document.getElementById('translator-config-template');
          const translatorConfig = document.importNode(translatorConfigTemplate.content, true);
          
          // Add the configuration to the plugin card
          pluginCard.appendChild(translatorConfig);
          
          // Set up the translator configuration
          setupTranslatorConfig(plugin);
        }
        
        // If this is the chat plugin, add its configuration
        if (plugin.name === 'chat') {
          const chatConfigTemplate = document.getElementById('chat-config-template');
          const chatConfig = document.importNode(chatConfigTemplate.content, true);
          
          // Add the configuration to the plugin card
          pluginCard.appendChild(chatConfig);
          
          // Set up the chat configuration
          setupChatConfig(plugin);
        }
      });
    }
    
    // Handle plugin actions (enable, disable, configure)
    function handlePluginAction(event) {
      const button = event.target;
      const pluginName = button.getAttribute('data-plugin');
      const action = button.getAttribute('data-action');
      
      switch (action) {
        case 'enable':
          enablePlugin(pluginName);
          break;
        case 'disable':
          disablePlugin(pluginName);
          break;
        case 'configure':
          togglePluginConfig(pluginName);
          break;
      }
    }
    
    // Enable a plugin
    function enablePlugin(pluginName) {
      fetch(`/api/plugins/${pluginName}/enable`, {
        method: 'POST'
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update the UI
            const plugin = plugins.find(p => p.name === pluginName);
            if (plugin) {
              plugin.enabled = true;
              renderPlugins(plugins);
            }
          }
        })
        .catch(error => {
          console.error(`Error enabling plugin ${pluginName}:`, error);
        });
    }
    
    // Disable a plugin
    function disablePlugin(pluginName) {
      fetch(`/api/plugins/${pluginName}/disable`, {
        method: 'POST'
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update the UI
            const plugin = plugins.find(p => p.name === pluginName);
            if (plugin) {
              plugin.enabled = false;
              renderPlugins(plugins);
            }
          }
        })
        .catch(error => {
          console.error(`Error disabling plugin ${pluginName}:`, error);
        });
    }
    
    // Toggle plugin configuration
    function togglePluginConfig(pluginName) {
      const configElement = document.getElementById(`${pluginName}-config`);
      if (configElement) {
        configElement.classList.toggle('active');
      }
    }
    
    // Set up translator configuration
    function setupTranslatorConfig(plugin) {
      console.log('Setting up translator config with:', plugin.config);
      const config = plugin.config || {};
      
      // Set up API key
      const apiKeyInput = document.getElementById('translator-api-key');
      apiKeyInput.value = config.apiKey || '';
      
      // Set up default language
      const defaultLanguageSelect = document.getElementById('translator-default-language');
      defaultLanguageSelect.innerHTML = '';
      
      // Make sure supportedLanguages exists
      const supportedLanguages = config.supportedLanguages || {
        'en': 'English',
        'es': 'Spanish',
        'fr': 'French',
        'de': 'German',
        'it': 'Italian',
        'pt': 'Portuguese',
        'ru': 'Russian',
        'ja': 'Japanese',
        'ko': 'Korean',
        'zh': 'Chinese'
      };
      
      // Add options to the dropdown
      for (const [code, name] of Object.entries(supportedLanguages)) {
        const option = document.createElement('option');
        option.value = code;
        option.textContent = name;
        if (code === config.defaultTargetLanguage) {
          option.selected = true;
        }
        defaultLanguageSelect.appendChild(option);
      }
      
      // Set up checkboxes
      document.getElementById('translator-incoming').checked = config.translateIncoming || false;
      document.getElementById('translator-outgoing').checked = config.translateOutgoing || true;
      
      // Set up outgoing languages
      const outgoingLanguagesContainer = document.getElementById('translator-outgoing-languages');
      outgoingLanguagesContainer.innerHTML = '';
      
      // Make sure outgoingLanguages exists
      const outgoingLanguages = config.outgoingLanguages || ['es', 'fr'];
      
      outgoingLanguages.forEach(langCode => {
        const langName = supportedLanguages[langCode];
        if (langName) {
          const langChip = document.createElement('div');
          langChip.className = 'language-chip';
          langChip.innerHTML = `
            <span>${langName} (${langCode})</span>
            <span class="language-chip-remove" data-lang="${langCode}">Ã—</span>
          `;
          
          // Add event listener for removing the language
          langChip.querySelector('.language-chip-remove').addEventListener('click', function() {
            const langCode = this.getAttribute('data-lang');
            const index = outgoingLanguages.indexOf(langCode);
            if (index !== -1) {
              outgoingLanguages.splice(index, 1);
              setupTranslatorConfig({...plugin, config: {...config, outgoingLanguages}});
            }
          });
          
          outgoingLanguagesContainer.appendChild(langChip);
        }
      });
      
      // Set up add language dropdown
      const addLanguageSelect = document.getElementById('translator-add-language');
      addLanguageSelect.innerHTML = '';
      
      for (const [code, name] of Object.entries(supportedLanguages)) {
        if (!outgoingLanguages.includes(code)) {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = name;
          addLanguageSelect.appendChild(option);
        }
      }
      
      // Add event listener for adding a language
      const addLanguageBtn = document.getElementById('translator-add-language-btn');
      
      // Remove any existing event listeners by cloning and replacing the button
      const newAddLanguageBtn = addLanguageBtn.cloneNode(true);
      addLanguageBtn.parentNode.replaceChild(newAddLanguageBtn, addLanguageBtn);
      
      // Add the event listener to the new button
      newAddLanguageBtn.addEventListener('click', function() {
        const langCode = document.getElementById('translator-add-language').value;
        console.log('Adding language:', langCode);
        
        if (langCode && !outgoingLanguages.includes(langCode)) {
          outgoingLanguages.push(langCode);
          setupTranslatorConfig({...plugin, config: {...config, outgoingLanguages}});
        }
      });
      
      // Add event listeners for save and cancel buttons
      const saveButton = document.getElementById('translator-save');
      const cancelButton = document.getElementById('translator-cancel');
      
      // Remove any existing event listeners by cloning and replacing the buttons
      const newSaveButton = saveButton.cloneNode(true);
      const newCancelButton = cancelButton.cloneNode(true);
      
      saveButton.parentNode.replaceChild(newSaveButton, saveButton);
      cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
      
      // Add the event listeners to the new buttons
      newSaveButton.addEventListener('click', function() {
        saveTranslatorConfig(plugin);
      });
      
      newCancelButton.addEventListener('click', function() {
        togglePluginConfig('translator');
      });
    }
    
    // Save translator configuration
    function saveTranslatorConfig(plugin) {
      // Disable the save button to prevent multiple submissions
      const saveButton = document.getElementById('translator-save');
      saveButton.disabled = true;
      saveButton.textContent = 'Saving...';
      
      // Get form values
      const apiKey = document.getElementById('translator-api-key').value;
      const defaultLanguage = document.getElementById('translator-default-language').value;
      const translateIncoming = document.getElementById('translator-incoming').checked;
      const translateOutgoing = document.getElementById('translator-outgoing').checked;
      
      // Get selected outgoing languages
      let outgoingLanguages = [];
      const outgoingLanguagesList = document.getElementById('translator-outgoing-languages');
      const languageTags = outgoingLanguagesList.querySelectorAll('.language-chip');
      
      languageTags.forEach(tag => {
        const langCode = tag.querySelector('.language-chip-remove').getAttribute('data-lang');
        if (langCode) {
          outgoingLanguages.push(langCode);
        }
      });
      
      // If no languages are selected but translation is enabled, add the default language
      if (translateOutgoing && outgoingLanguages.length === 0) {
        outgoingLanguages.push(defaultLanguage);
      }
      
      // Create config object
      const config = {
        apiKey: apiKey || '',
        defaultTargetLanguage: defaultLanguage,
        translateIncoming: translateIncoming,
        translateOutgoing: translateOutgoing,
        outgoingLanguages: outgoingLanguages
      };
      
      console.log('Saving translator config:', config);
      
      // Send configuration to server
      fetch(`/api/plugins/${plugin.name}/config`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show success message
          alert('Translator configuration saved successfully!');
          
          // Update plugin in the list
          plugin.config = config;
          togglePluginConfig('translator');
        } else {
          alert('Error saving configuration: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error saving configuration:', error);
        alert('Error saving configuration: ' + error.message);
      })
      .finally(() => {
        // Re-enable the save button
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
      });
    }
    
    // Set up chat configuration
    function setupChatConfig(plugin) {
      console.log('Setting up chat config with:', plugin.config);
      const config = plugin.config || {};
      
      // Set up max messages
      const maxMessagesInput = document.getElementById('chat-max-messages');
      maxMessagesInput.value = config.maxMessages || 100;
      
      // Set up checkboxes
      document.getElementById('chat-show-timestamps').checked = config.showTimestamps !== false;
      document.getElementById('chat-show-badges').checked = config.showBadges !== false;
      document.getElementById('chat-highlight-mentions').checked = config.highlightMentions !== false;
      document.getElementById('chat-filter-commands').checked = config.filterCommands === true;
      document.getElementById('chat-show-notifications').checked = config.showNotifications !== false;
      
      // Set up font size
      const fontSizeSelect = document.getElementById('chat-font-size');
      fontSizeSelect.value = config.fontSizeChat || 'medium';
      
      // Set up colors
      const chatColors = config.chatColors || {};
      document.getElementById('chat-color-background').value = chatColors.background || '#1e1e1e';
      document.getElementById('chat-color-text').value = chatColors.text || '#e0e0e0';
      document.getElementById('chat-color-timestamp').value = chatColors.timestamp || '#888888';
      document.getElementById('chat-color-username').value = chatColors.username || '#4CAF50';
      document.getElementById('chat-color-mention').value = chatColors.mention || '#ff9800';
      document.getElementById('chat-color-command').value = chatColors.command || '#2196F3';
      
      // Add event listeners for save and cancel buttons
      const saveButton = document.getElementById('chat-save');
      const cancelButton = document.getElementById('chat-cancel');
      
      // Remove any existing event listeners by cloning and replacing the buttons
      const newSaveButton = saveButton.cloneNode(true);
      const newCancelButton = cancelButton.cloneNode(true);
      
      saveButton.parentNode.replaceChild(newSaveButton, saveButton);
      cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
      
      // Add the event listeners to the new buttons
      newSaveButton.addEventListener('click', function() {
        saveChatConfig(plugin);
      });
      
      newCancelButton.addEventListener('click', function() {
        togglePluginConfig('chat');
      });
    }
    
    // Save chat configuration
    function saveChatConfig(plugin) {
      // Disable the save button to prevent multiple submissions
      const saveButton = document.getElementById('chat-save');
      saveButton.disabled = true;
      saveButton.textContent = 'Saving...';
      
      // Get form values
      const maxMessages = parseInt(document.getElementById('chat-max-messages').value) || 100;
      const showTimestamps = document.getElementById('chat-show-timestamps').checked;
      const showBadges = document.getElementById('chat-show-badges').checked;
      const highlightMentions = document.getElementById('chat-highlight-mentions').checked;
      const fontSizeChat = document.getElementById('chat-font-size').value;
      const filterCommands = document.getElementById('chat-filter-commands').checked;
      const showNotifications = document.getElementById('chat-show-notifications').checked;
      
      // Get color values
      const chatColors = {
        background: document.getElementById('chat-color-background').value,
        text: document.getElementById('chat-color-text').value,
        timestamp: document.getElementById('chat-color-timestamp').value,
        username: document.getElementById('chat-color-username').value,
        mention: document.getElementById('chat-color-mention').value,
        command: document.getElementById('chat-color-command').value
      };
      
      // Create config object
      const config = {
        maxMessages,
        showTimestamps,
        showBadges,
        highlightMentions,
        fontSizeChat,
        filterCommands,
        showNotifications,
        chatColors
      };
      
      console.log('Saving chat config:', config);
      
      // Send configuration to server
      fetch(`/api/plugins/${plugin.name}/config`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show success message
          alert('Chat configuration saved successfully!');
          
          // Update plugin in the list
          plugin.config = config;
          togglePluginConfig('chat');
          
          // Apply the chat styles immediately if possible
          applyChatStyles(config);
        } else {
          alert('Error saving configuration: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error saving configuration:', error);
        alert('Error saving configuration: ' + error.message);
      })
      .finally(() => {
        // Re-enable the save button
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
      });
    }
    
    // Apply chat styles immediately
    function applyChatStyles(config) {
      // This function can be used to apply chat styles to the main dashboard
      // It would need to communicate with the main dashboard via WebSocket or localStorage
      
      // For now, we'll just store the settings in localStorage
      try {
        localStorage.setItem('chatConfig', JSON.stringify(config));
        console.log('Chat configuration saved to localStorage');
      } catch (error) {
        console.error('Error saving chat configuration to localStorage:', error);
      }
    }
    
    // Initial updates
    updateStatus();
    fetchPlugins();
    
    // Set up polling
    setInterval(updateStatus, 5000);
  </script>
</body>
</html> 